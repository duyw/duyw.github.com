<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: PostgreSQL | 杜永文 博客]]></title>
  <link href="http://duyw.github.io/blog/categories/postgresql/atom.xml" rel="self"/>
  <link href="http://duyw.github.io/"/>
  <updated>2014-02-11T22:02:35+08:00</updated>
  <id>http://duyw.github.io/</id>
  <author>
    <name><![CDATA[Du Yongwen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[PostgreSQL 常用函数]]></title>
    <link href="http://duyw.github.io/blog/2014/01/29/postgresql-chang-yong-han-shu/"/>
    <updated>2014-01-29T00:09:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/29/postgresql-chang-yong-han-shu</id>
    <content type="html"><![CDATA[<h3>一 常用数学操作符</h3>

<pre><code>%    模      5 % 4      1
^    幂      2.0 ^ 3.0  8
|/   平方根  |/ 25.0     5
||/  立方根  ||/ 27.0    3
!    阶乘    5 !        120
!!   阶乘    !! 5       120
@    绝对值   @ -5.0     5
</code></pre>

<h3>二 常用数学函数</h3>

<p>取绝对值： <code>abs()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">);</span> <span class="c1">-- 5</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>求余数： <code>mod(x,y)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">mod</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span> <span class="c1">--1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>平方根： <code>sqrt()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="c1">-- 2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>立方根： <code>cbrt()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">cbrt</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">--2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>随机数： <code>random()</code>, 0.0 到 1.0 之间
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">random</span><span class="p">();</span> <span class="c1">-- 0.527410356327891</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>不小于参数的最小的整数： <code>cell()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">cell</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">.</span><span class="mi">8</span><span class="p">);</span> <span class="c1">-- -42</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>不大于参数的最大整数: <code>floor()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">floor</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">.</span><span class="mi">8</span><span class="p">);</span> <span class="c1">-- -43`</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>三 字符串函数</h3>

<p>字符串连接： <code>string || string</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="s1">&#39;ruby&#39;</span> <span class="o">||</span> <span class="s1">&#39;china&#39;</span> <span class="p">;</span> <span class="c1">-- rubychina</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<!-- more -->


<p>字符串长度： <code>length()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">length</span><span class="p">(</span><span class="s1">&#39;i love you&#39;</span><span class="p">)</span> <span class="p">;</span> <span class="c1">-- 10</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>字符串转小写： <code>lower()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">lower</span><span class="p">(</span><span class="s1">&#39;RUBY&#39;</span><span class="p">);</span> <span class="c1">-- ruby</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>字符串转大写： <code>upper()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">upper</span><span class="p">(</span><span class="s1">&#39;rails&#39;</span><span class="p">);</span> <span class="c1">-- RAILS</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>字符串每个单词的第一个子母转为大写： <code>initcap()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">initcap</span><span class="p">(</span><span class="s1">&#39;ruby on rails&#39;</span><span class="p">);</span> <span class="c1">-- Ruby on Rails</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>字符串替换： <code>overlay(string placing string from int [for int])</code> 和</p>

<p><code>replace(string text, from text, to text)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">overlay</span><span class="p">(</span><span class="s1">&#39;Ruby&lt;strong&gt;&lt;strong&gt;&lt;strong&gt;&lt;em&gt;Rails&#39;</span> <span class="k">placing</span> <span class="s1">&#39; on &#39;</span> <span class="k">from</span> <span class="mi">5</span> <span class="k">for</span> <span class="mi">7</span><span class="p">)</span><span class="err">；</span><span class="c1">-- Ruby on Rails</span>
</span><span class='line'><span class="k">select</span> <span class="k">replace</span><span class="p">(</span><span class="s1">&#39;Ruby&lt;/em&gt;&lt;/strong&gt;&lt;/strong&gt;&lt;/strong&gt;Rails&#39;</span><span class="p">,</span> <span class="s1">&#39;_______&#39;</span><span class="p">,</span> <span class="s1">&#39; on &#39;</span><span class="p">);</span> <span class="c1">-- Ruby on Rails`</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>截取字符串： <code>substring(string [from int] [for int])</code> 和 <code>substr(string, from [, count])</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="s1">&#39;Ruby on Rails&#39;</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">-- Ruby</span>
</span><span class='line'><span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="s1">&#39;Ruby on Rails&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>        <span class="c1">-- Ruby</span>
</span><span class='line'><span class="k">select</span> <span class="n">substr</span><span class="p">(</span><span class="s1">&#39;Ruby on Rails&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>           <span class="c1">-- Ruby</span>
</span><span class='line'><span class="k">select</span> <span class="n">substr</span><span class="p">(</span><span class="s1">&#39;Ruby on Rails&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>              <span class="c1">-- on Rails</span>
</span><span class='line'><span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span> <span class="k">from</span> <span class="s1">&#39;%#&quot;o_b#&quot;%&#39;</span> <span class="k">FOR</span> <span class="s1">&#39;#&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">-- oob  (这里#是转义符，双引号内的模式是返回部分)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>子字符串位置 <code>position(substring in string)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">position</span><span class="p">(</span><span class="s1">&#39;ruby-china&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">-- 5 (利用这个特性可以用于判断字符串中是否包含某个子字符串)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>去除首位空格：<code>trim(string)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">trim</span><span class="p">(</span><span class="s1">&#39;    ruby    &#39;</span><span class="p">);</span>  <span class="c1">-- &#39;ruby&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>去除左边空格/字符： <code>ltrim(string text [, characters text])</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">ltrim</span><span class="p">(</span><span class="s1">&#39;    ruby&#39;</span><span class="p">)</span> <span class="c1">-- ruby</span>
</span><span class='line'><span class="k">select</span> <span class="n">ltrim</span><span class="p">(</span><span class="s1">&#39;&lt;em&gt;_ruby&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;/em&gt;&#39;</span><span class="p">)</span> <span class="c1">-- ruby</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>去除右边空格/字符： <code>rtrim(string text [, characters text])</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">rtrim</span><span class="p">(</span><span class="s1">&#39;ruby    &#39;</span><span class="p">)</span>    <span class="c1">-- ruby</span>
</span><span class='line'><span class="k">select</span> <span class="n">rtrim</span><span class="p">(</span><span class="s1">&#39;ruby&lt;em&gt;_&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;/em&gt;&#39;</span><span class="p">)</span>  <span class="c1">-- ruby</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>获取字符串的 MD5 值：<code>md5()</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">md5</span><span class="p">(</span><span class="s1">&#39;ruby&#39;</span><span class="p">);</span> <span class="c1">-- 58e53d1324eef6265fdb97b08ed9aadf</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>字符串分割： <code>split_part(string text, delimiter text, field int)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">split_part</span><span class="p">(</span><span class="s1">&#39;i||love||you&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">-- love</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>四 模式匹配</h3>

<h4>Like</h4>

<p>用法举例</p>

<pre><code>'abc' LIKE 'abc'    true
'abc' LIKE 'a%'     true
'abc' LIKE '_b_'    true
'abc' LIKE 'c'      false  
</code></pre>

<p>下划线(_)代表匹配任何单个字符，而一个百分号(%)匹配任何零或更多字符，如：</p>

<h4>SIMILAR TO正则表达式</h4>

<p>SIMILAR TO根据模式是否匹配给定的字符串而返回真或者假。
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">string</span> <span class="k">SIMILAR</span> <span class="k">TO</span> <span class="n">pattern</span> <span class="p">[</span><span class="k">ESCAPE</span> <span class="k">escape</span><span class="o">-</span><span class="nb">character</span><span class="p">]</span>
</span><span class='line'><span class="n">string</span> <span class="k">NOT</span> <span class="k">SIMILAR</span> <span class="k">TO</span> <span class="n">pattern</span> <span class="p">[</span><span class="k">ESCAPE</span> <span class="k">escape</span><span class="o">-</span><span class="nb">character</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>它和LIKE非常类似，支持LIKE的通配符('_'和'%')且保持其原意。除此之外，SIMILAR TO还支持一些自己独有的元字符，如：</p>

<ol>
<li><p>| 标识选择(两个候选之一)。</p></li>
<li><ul>
<li>表示重复前面的项零次或更多次。</li>
</ul>
</li>
<li><ul>
<li>表示重复前面的项一次或更多次。</li>
</ul>
</li>
<li><p>可以使用圆括弧()把项组合成一个逻辑项。</p></li>
<li><p>一个方括弧表达式[...]声明一个字符表，就像POSIX正则表达式一样。</p></li>
</ol>


<p>见如下示例：</p>

<pre><code>'abc' SIMILAR TO 'abc'            -- true
'abc' SIMILAR TO 'a'              -- false
'abc' SIMILAR TO '%(b|d)%'        -- true
'abc' SIMILAR TO '(b|c)%'         -- false
</code></pre>

<p>带三个参数的substring，substring(string from pattern for escape-character)，提供了一个从字串中抽取一个匹配SQL正则表达式模式的子字串的函数。和SIMILAR TO一样，声明的模式必须匹配整个数据串，否则函数失效并返回NULL。为了标识在成功的时候应该返回的模式部分，模式必须出现后跟双引号(")的两个转 义字符。匹配这两个标记之间的模式的字串将被返回，如：
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="k">substring</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span> <span class="k">from</span> <span class="s1">&#39;%#&quot;o_b#&quot;%&#39;</span> <span class="k">FOR</span> <span class="s1">&#39;#&#39;</span><span class="p">);</span> <span class="c1">-- oob</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h4>用于日期/时间格式化的模式</h4>

<pre><code>模式    描述
HH     一天的小时数(01-12)
HH12   一天的小时数(01-12)
HH24   一天的小时数(00-23)
MI     分钟(00-59)
SS     秒(00-59)
MS     毫秒(000-999)
US     微秒(000000-999999)
AM     正午标识(大写)
Y,YYY  带逗号的年(4和更多位)
YYYY   年(4和更多位)
YYY    年的后三位
YY     年的后两位
Y      年的最后一位
MONTH  全长大写月份名(空白填充为9字符)
Month  全长混合大小写月份名(空白填充为9字符)
month  全长小写月份名(空白填充为9字符)
MON    大写缩写月份名(3字符)
Mon    缩写混合大小写月份名(3字符)
mon    小写缩写月份名(3字符)
MM     月份号(01-12)
DAY    全长大写日期名(空白填充为9字符)
Day    全长混合大小写日期名(空白填充为9字符)
day    全长小写日期名(空白填充为9字符)
DY     缩写大写日期名(3字符)
Dy     缩写混合大小写日期名(3字符)
dy     缩写小写日期名(3字符)
DDD    一年里的日子(001-366)
DD     一个月里的日子(01-31)
D      一周里的日子(1-7；周日是1)
W      一个月里的周数(1-5)(第一周从该月第一天开始)
WW     一年里的周数(1-53)(第一周从该年的第一天开始)
</code></pre>

<h3>五 日期/时间函数</h3>

<p>当前时间： <code>localtime</code>, <code>localtimestamp</code>, <code>now()</code>, <code>current_time</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">localtime</span><span class="p">,</span> <span class="k">localtimestamp</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="k">current_time</span><span class="p">;</span>
</span><span class='line'><span class="c1">--00:06:12.109832 | 2014-01-29 00:06:12.109832 | 2014-01-29 00:06:12.109832+08 | 00:06:12.109832+08</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>当前日期： <code>current_date</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">current_date</span><span class="p">;</span> <span class="c1">-- 2014-01-28</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>当前日期和时间： <code>current_timestamp</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">current_timestamp</span><span class="p">;</span> <span class="c1">-- 2014-01-28 23:40:14.761216+08</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>获取子域： <code>date_part(text, timestamp)</code>, 等同于 <code>extract(field from timestamp)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>   <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 2014</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span>  <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 1</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span>    <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 28</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;week&#39;</span><span class="p">,</span>   <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 5</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span>   <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 23</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 40</span>
</span><span class='line'><span class="k">select</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="k">timestamp</span><span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span> <span class="c1">-- 14.761216&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">select</span> <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="k">timestamp</span> <span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span>  <span class="c1">-- 2014</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>截断成指定的精度: <code>date_trunc(text, timestamp)</code>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">date_trunc</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="k">timestamp</span> <span class="s1">&#39;2014-01-28 23:40:14.761216+08&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">-- 2014-01-28 23:00:00</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Tips</h3>

<hr />

<p>1 BETWEEN</p>

<p><code>a BETWEEN x AND y</code> 等效于 <code>a &gt;= x AND a &lt;= y</code></p>

<p><code>a NOT BETWEEN x AND y</code> 等效于 <code>a &lt; x OR a &gt; y</code></p>

<p>2 拼接多条记录的值</p>

<p><code>select array_to_string( array(select nickname from users where id &lt; 100), ';')</code>:</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PostgreSQL 字段分割分组]]></title>
    <link href="http://duyw.github.io/blog/2014/01/28/postgresql-zi-duan-fen-ge-fen-zu/"/>
    <updated>2014-01-28T20:43:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/28/postgresql-zi-duan-fen-ge-fen-zu</id>
    <content type="html"><![CDATA[<p>原始： 在import_products中的location_prices字段存储内容：</p>

<pre><code> id  | location_prices  
-----|---------------------
  1  | 北京:200.0;河南:100.0
  2  | 河南;100.0
</code></pre>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">id</span> <span class="p">,</span>
</span><span class='line'>  <span class="n">split_part</span><span class="p">(</span><span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">location_prices</span><span class="p">,</span><span class="s1">&#39;;&#39;</span><span class="p">)),</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">area_name</span><span class="p">,</span>
</span><span class='line'>  <span class="n">split_part</span><span class="p">(</span><span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">location_prices</span><span class="p">,</span><span class="s1">&#39;;&#39;</span><span class="p">)),</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">price</span>
</span><span class='line'><span class="k">from</span> <span class="n">import_products</span>
</span><span class='line'><span class="k">where</span> <span class="n">id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">542796</span><span class="p">,</span><span class="mi">542797</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>结果：</p>

<pre><code> id  | area_name | price  
-----|-----------|-------
  1  |    北京    | 200.0
  1  |    河南    | 100.0
  2  |    河南    | 100.0
</code></pre>

<p>知识点：</p>

<h3>1. string_to_array</h3>

<p>string_to_array函数的作用是将string类型的字符串分割成数组。
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">string_to_array</span><span class="p">(</span><span class="s1">&#39;i|love|you&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="p">;</span>  <span class="c1">-- {i,love,you}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>2. unnest</h3>

<p>unnest 函数的作用是将数组转换成行。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">unnest</span><span class="p">(</span><span class="nb">array</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;love&#39;</span><span class="p">,</span><span class="s1">&#39;you&#39;</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<pre><code>unnest  
-------
  i
 love
  you
</code></pre>

<h3>3. split_part</h3>

<p>split_part 函数作用是将字符串按照另一个字符串进行分割，并返回分隔以后的
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">split_part</span><span class="p">(</span><span class="s1">&#39;i||love||you&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span><span class="o">`</span> <span class="c1">-- love</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu12.04 安装 PostgreSQL 和 PgAdmin3]]></title>
    <link href="http://duyw.github.io/blog/2013/04/04/ubuntu12-dot-04-an-zhuang-postgresqlhe-pgadmin3/"/>
    <updated>2013-04-04T19:33:00+08:00</updated>
    <id>http://duyw.github.io/blog/2013/04/04/ubuntu12-dot-04-an-zhuang-postgresqlhe-pgadmin3</id>
    <content type="html"><![CDATA[<h3>1.安装</h3>

<p>安装：<code>sudo apt-get install postgresql postgresql-client postgresql-server-dev-all</code></p>

<p>或者指定版本号：</p>

<pre><code>sudo apt-get install -y postgresql-9.1 postgresql-client-9.1 postgresql-contrib-9.1 \
postgresql-server-dev-9.1
</code></pre>

<p>启动：<code>sudo /etc/init.d/postgresql start</code></p>

<p>停止：<code>sudo /etc/init.d/postgresql stop</code></p>

<p>重启：<code>sudo /etc/init.d/postgresql restart</code></p>

<p>察看状态：<code>sudo /etc/init.d/postgresql status</code></p>

<p>另外，也可以使用命令：<code>sudo service postgresql  [start/stop/restart/status]</code></p>

<p>以上命令将把PostgreSQL安装到以下目录：</p>

<pre><code>/usr/lib/postgresql/9.1/        存放postgresql相关的二进制文件
/usr/lib/postgresql/9.1/bin/    可执行文件 
/usr/lib/postgresql/9.1/lib/    共享库文件 
/etc/postgres/9.1/main/         存放postgresql配置文文件 
/var/lib/postgresql/            postgres用户的主文件夹
</code></pre>

<!-- more -->


<h3>2.配置管理员“postgres”，使用psql</h3>

<p>PostgreSQL数据默认会创建一个linux用户postgres，需要修改操作系统“postgres”用户的密码为“postgres”：</p>

<ol>
<li><p>删除密码：<code>sudo passwd -d postgres  //passwd -d 是清空指定用户密码的意思</code></p></li>
<li><p>设置密码：<code>sudo -u postgres passwd  //或者 sudo su postgres -c passwd</code></p></li>
</ol>


<p>用sudo权限以用户postgres身份登陆PostgreSQL:</p>

<pre><code>sudo -u postgres psql [ -U postgres -h 127.0.0.1]   
// 运行psql,后面[]中的内容可选，用于登录服务器，默认会登录本机；
</code></pre>

<p>或者：</p>

<p><code>sudo su postgres -c psql template1（PostgreSQL的默认数据库是template1）</code></p>

<p>运行 PostgreSQL 交互的终端程序， 叫 psql，它允许你交互地输入，编辑，和执行 SQL 命令。</p>

<p>启动 psql：<code>psql mydb</code>（以用户postgres登陆psql：<code>sudo su postgres -c psql</code>）</p>

<p>在 psql 里输入help命令，你会看到下面的提示信息：</p>

<pre><code>You are using psql, the command-line interface to PostgreSQL.
Type:  \copyright for distribution terms
          \h for help with SQL commands
          \? for help with psql commands
          \g or terminate with semicolon to execute query
          \q to quit
</code></pre>

<p>修改PostgreSQL的管理员用户postgres的密码为“postgres”（同操作系统用户postgres的密码一样）：</p>

<p><code>postgres=# ALTER USER postgres WITH PASSWORD 'postgres';</code></p>

<p>查询当前使用的postgresql版本：<code>SELECT version()；</code></p>

<p>查询大概年前日期：            <code>SELECT current_date;</code></p>

<p>现在，我们就可以在数据库服务器上用 postgres帐号通过psql或者pgAdmin等等客户端操作数据库了
（暂时还不能远程访问）。</p>

<h3>3.管理PostgreSQL用户</h3>

<p>1 创建新用户pgsql，但不给建数据库的权限，有两中创建方式：</p>

<p><strong>一种是在外部命令行直接创建：</strong></p>

<p>  命令：<code>createuser [-a] [-A] [-d] [-D] [-e] [-P] [-h 主机名] [-p port] 用户名</code></p>

<pre><code>参数说明：
[-a]：允许创建其他用户，相当于创建一个超级用户；
[-A]：不允许此用户创建其他用户；
[-d]：允许此用户创建数据库；
[-D]：不允许此用户创建数据库；
[-e]：将执行过程显示到Shell上；
[-P]：创建用户时，同时设置密码；
[-h 主机名]：为某个主机上的Postgres创建用户；
[-p port]：与-h参数一同使用，指定主机的端口。
</code></pre>

<p>例如：</p>

<p><code>ivan@ubuntu:~$ sudo -u postgres createuser -D -P pgsql</code></p>

<p>执行以后会看到如下提示：</p>

<pre><code>Enter password for new role: 
Enter it again: 
Shall the new role be a superuser? (y/n) n
Shall the new role be allowed to create more new roles? (y/n) n
</code></pre>

<p><strong>另一种方式是登陆psql，通过SQL语句创建：</strong></p>

<p>首先登陆：</p>

<p><code>ivan@ubuntu:~$ psql -U postgres -h 127.0.0.1</code></p>

<p>然后创建：</p>

<pre><code>postgres=# create user “pgsql” with password ‘123456’ nocreatedb; 
//用户名和数据库名称加上引号后才区分大小写，否则会自动转换成小写
</code></pre>

<p>2 删除用户：</p>

<p>外部：<code>sudo -u postgres dropuser pgsql</code></p>

<p>内部：``</p>

<h3>4.创建和删除数据库</h3>

<p>同样有外部命令行和psql的SQL语句这两种创建方式。</p>

<p>创建数据库 mydb, 其拥有者是pgsql用户：</p>

<p>1  通过命令行创建（shell命令）：</p>

<p>创建数据库：<code>sudo -u postgres createdb mydb -O pgsql   // -O 设定所有者pgsql；</code></p>

<p>删除数据库：<code>sudo -u postgres dropdb   mydb</code></p>

<p>2  通过psql来创建(sql命令)：</p>

<p>首先利用psql登录PostgreSQL服务器:</p>

<pre><code>sudo -u postgres psql [ -U postgres -h 127.0.0.1]  
//运行psql,后面[]中的内容可选，用于登录服务器，默认会登录本机；`
</code></pre>

<p>然后在psql程序中创建数据库（需要先创建好pgsql用户）:</p>

<p><code>create database “mydatabase” with owner=pgsql;</code></p>

<h3>5.数据库导入导出</h3>

<p><strong>导出：</strong>取得服务器 192.168.1.1 上 PostgreSQL中pgsql用户的mydb数据库，导出到当前目录下的 mydb.dump 文件：</p>

<p><code>pg_dump -h 192.168.1.1 -U pgsql -Fc mydb &gt; mydb.dump</code></p>

<p><strong>导入：</strong>将导出的文件 mydb.dump 导入到本地PostgreSQL数据库中pgsql用户下(需要提前创建pgsql用户），要求导入后的数据库名称为“mydb”</p>

<p><code>pg_restore ./mydb.dump | psql -Upgsql -d mydb</code></p>

<h3>6.修改PostgresSQL数据库配置实现远程访问</h3>

<p><code>ivan@ubuntu:~$ sudo vim /etc/postgresql/9.1/main/postgresql.conf</code></p>

<p>1.监听任何地址访问，修改连接权限</p>

<p><code>#listen_addresses = ‘localhost’  改为 listen_addresses = ‘*’</code></p>

<p>2.启用密码验证</p>

<p><code>#password_encryption = on      改为   password_encryption = on</code></p>

<p>3.可访问的用户ip段</p>

<p><code>ivan@ubuntu:~$ sudo vim /etc/postgresql/9.1/main/pg_hba.conf</code></p>

<p>并在文档末尾加上以下内容</p>

<pre><code># to allow your client visiting postgresql server
host all all 0.0.0.0 0.0.0.0 md5
</code></pre>

<p>解释一下最后一行：</p>

<pre><code>host表示允许的类型是主机； 
第一个all是允许的数据库名字； 
第二个all是允许的用户； 
第一个0.0.0.0是允许访问的ip address； 
第二个0.0.0.0是允许访问的subnet mask； 
最后的md5表示密码的加密方式，如果将md5改成trust则可以让指定范围的主机数据库的时候不需要提供密码。
关于 ip address 和 subnet mask ，你也可以修改为你的机器IP地址(如10.13.19.53)和子网掩码(如 255.255.255.255)，
这样就只有你自己的主机可以远程访问数据库了。 如果要使用一个IP地址范围，只需要把子网掩码设置成合适的值，
如果子网掩码设置成0.0.0.0，则所有主机均可以访问数据库（IP可以任意设定），
如果将md5改成trust则可以让指定范围的主机访问指定的数据库的时候不需要提供密码。
</code></pre>

<p>4.重启PostgreSQL数据库</p>

<p><code>ivan@ubuntu:~$ sudo /etc/init.d/postgresql restart</code></p>

<h3>7.安装postgresql数据库pgAdmin3客户端管理程序</h3>

<p><code>ivan@ubuntu:~$ sudo apt-get install -y pgadmin3</code></p>

<p>遇到问题：</p>

<p>1 安装过程中总是下载不了要安装的文件，更新源添加163源都无法解决，最后通过vpn翻墙以后可以正常安装。</p>

<p>2 安装以后pgAdmin3固定到启动器后不显示图标，解决方法，修改/usr/share/applications目录下的 pgAdmin III.desktop文件，将其中的 Icon值改为“/usr/share/pixmaps/pgadmin3.svg”，搞定。</p>
]]></content>
  </entry>
  
</feed>
