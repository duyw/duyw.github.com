<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Rails | 杜永文 博客]]></title>
  <link href="http://duyw.github.io/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://duyw.github.io/"/>
  <updated>2014-01-27T19:13:49+08:00</updated>
  <id>http://duyw.github.io/</id>
  <author>
    <name><![CDATA[Du Yongwen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Reactor 模式]]></title>
    <link href="http://duyw.github.io/blog/2014/01/27/reactor-mo-shi/"/>
    <updated>2014-01-27T19:11:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/27/reactor-mo-shi</id>
    <content type="html"><![CDATA[<p>Reactor 设计模式（也叫反应器模式，或者应答者模式）是一种基于事件驱动的设计模式，这种模式像是一个女仆或者服务员，随时等待你的召唤。</p>

<p>高并发的场景经常使用Reactor模式取代常用的多线程处理模式，以节省系统资源，提高系统的吞吐量。</p>

<p>说到这里到底什么是Reactor模式，什么又是多线程模式呢？我们举个栗子：</p>

<p>假设有这么一个场景：你去餐厅吃饭，首先要有服务员将菜单拿给你，你选好以后，服务员帮你完成点餐。</p>

<p>第一种情况：  每有一位乘客光临，就分配一个服务员帮助点餐。</p>

<p>第二种情况：  当乘客来到来以后，服务员会给你菜单，你先点菜。这时服务员去服务其他客人，当你选好以后招呼一下‘服务员’，会有服务员过来帮你点餐。</p>

<p>每个客人好比是一个请求事件，餐厅的服务员好比请求的处理。</p>

<p>第一种情况就是典型的多线程模式，每一个事件到来，都会分配一个线程来处理请求。无疑这样的服务是最好的，每个客人都会觉得自己是vip，于是这家店的口碑越来越好，越来越多的客人来这里用餐，很快老板就发现忙不过来了，多请服务员吧，占地方不说还要多出工钱，成本太大了。</p>

<p>显然第二种情况更好一点，较少的资源服务了较多的客人，这就是Reactor模式，用单线程来干多线程的事，进程和线程的开销是很大的，内存占用高不说，上下文之间的切换也是很慢的。</p>

<p>Reactor模式主要是提高系统的吞吐量，在有限的资源下处理更多的事情。</p>

<p>利用Reactor模式的框架：</p>

<p>Node.js
Gevent、Twisted、Tornado（Python）
EventMachine、Rev（Ruby）</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails 代理方法 delegate]]></title>
    <link href="http://duyw.github.io/blog/2014/01/27/rails-dai-li-fang-fa-delegate/"/>
    <updated>2014-01-27T18:58:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/27/rails-dai-li-fang-fa-delegate</id>
    <content type="html"><![CDATA[<p>通过delegate方法，在Foo对象中可以直接引用Greeter对象的方法：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Greeter</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hello</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;&quot;hello&quot;</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">goodbye</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;&quot;goodbye&quot;</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">Foo</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:greeter</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="ss">:hello</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:greeter</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;Foo.new.hello   # =&gt; &quot;hello&quot;</span>
</span><span class='line'><span class="sr">Foo.new.goodbye # =&gt; NoMethodError: undefined method `goodbye&#39; for #&amp;lt;Foo:0x1af30c&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Multiple delegates to the same target are allowed:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:greeter</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="ss">:hello</span><span class="p">,</span> <span class="ss">:goodbye</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:greeter</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;Foo.new.hello   # =&gt; &quot;hello&quot;</span>
</span><span class='line'><span class="sr">Foo.new.goodbye # =&gt; &quot;goodbye&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>delegate方法首先检查传入的参数，正确参数形式为:method1, :method2, ..., :methodN, :to => klass[, :prefix => prefix]</p>

<p>delegate要求参数的最后必须是一个Hash，
:to表示需要代理的类，:prefix表示代理的方法是否要加前缀，
如果:prefix => true，则代理的方法名为klass_method1, klass_method2, ..., klass_methodN，</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'> <span class="n">delegate</span> <span class="ss">:hello</span><span class="p">,</span> <span class="ss">:goodbye</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:greeter</span><span class="p">,</span> <span class="ss">:prefix</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;Foo.new.greeter_hello   # =&gt; &quot;hello&quot;&lt;br/</span><span class="o">&gt;</span>
</span><span class='line'><span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">greeter_goodbye</span> <span class="c1"># =&gt; &quot;goodbye&quot;&lt;br/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>如果:prefix => prefix (prefix为string)，则代理的方法名为prefix_method1, prefix_method2, ..., prefix_methodN。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="ss">:hello</span><span class="p">,</span> <span class="ss">:goodbye</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:greeter</span><span class="p">,</span> <span class="ss">:prefix</span> <span class="o">=&gt;</span> <span class="ss">:foo</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;Foo.new.foo_hello   # =&gt; &quot;hello&quot;&lt;br/</span><span class="o">&gt;</span>
</span><span class='line'><span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo_goodbye</span> <span class="c1"># =&gt; &quot;goodbye&quot;&lt;br/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Controller 中使用 helper]]></title>
    <link href="http://duyw.github.io/blog/2014/01/27/controller-zhong-shi-yong-helper/"/>
    <updated>2014-01-27T18:54:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/27/controller-zhong-shi-yong-helper</id>
    <content type="html"><![CDATA[<p>helper方法默认只能在view层调用（比如strip_tags方法）。如果想要在controller或model中使用，有两中方法：</p>

<h3>方法一：</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;ActionController::Base.helpers.strip_tags(&#39;string&#39;)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>方法二：</h3>

<p>用代理delegate</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="s2">&quot;strip_tags&quot;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s2">&quot;ActionController::Base.helpers&quot;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;strip_tags(&quot;html...&quot;)</span>
</span><span class='line'><span class="sr">...</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails 小坑]]></title>
    <link href="http://duyw.github.io/blog/2014/01/27/rails-xiao-keng/"/>
    <updated>2014-01-27T12:03:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/27/rails-xiao-keng</id>
    <content type="html"><![CDATA[<p>我在一个controller中定义了一个action，在这个action的最后：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Ruby代码: </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">redirect_to</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term_id</span><span class="o">]</span> <span class="p">,</span> <span class="ss">:data_type</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:data_type</span><span class="o">]</span><span class="p">,</span> <span class="ss">:specialty</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:specialty</span><span class="o">]</span><span class="p">,</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;            :norm_series =&amp;gt; params[:norm_series], :range_from =&amp;gt; params[:range_from], :range_to =&amp;gt; params[:range_to],</span>
</span><span class='line'><span class="sr">            :top_type =&amp;gt; params[:top_type], :sub_type =&amp;gt; params[:sub_type], :review_type =&amp;gt; params[:review_type],</span>
</span><span class='line'><span class="sr">            :status =&amp;gt; params[:status], :page_size =&amp;gt; params[:page_size] || 20, :page =&amp;gt; params[:page] || 1</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>当这个页面执行完以后，没有转到‘show’页面，却进入了一个空白的页面，这个页面只有一句话：</p>

<p>You are being redirected.</p>

<p>点击 'redirected' 以后，页面才跳转到'show' 页面，百思不得其姐。</p>

<p>最后通过查资料和自己思考终于知道原因了，关键在于后面的堆参数，其中有个 status 变量。哈哈~</p>

<p>说到这里你应该能猜到原因了吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails 命令行工具]]></title>
    <link href="http://duyw.github.io/blog/2014/01/27/rails-ming-ling-xing-gong-ju/"/>
    <updated>2014-01-27T11:58:00+08:00</updated>
    <id>http://duyw.github.io/blog/2014/01/27/rails-ming-ling-xing-gong-ju</id>
    <content type="html"><![CDATA[<p>rails 命令行工具</p>

<p>整理一些不常用的但是很有用的命令行工具：</p>

<p>1 rails c --sandbox</p>

<p>在沙盒模式下启动rails命令行，再此所做的对数据的修改都会会滚。</p>

<p>2 rails runner "puts User.first.id"</p>

<p>在rails环境下执行ruby代码，无需启动应用服务。</p>

<p>3 rails dbconsole</p>

<p>启动数据库的命令行，无需数据用户名密码，支持MySQL, PostgreSQL, SQLite and SQLite3.</p>

<p>4 rails destroy</p>

<p>回滚 rails g 对项目的改变。</p>

<p>5 rake -T</p>

<p>查看所有的rake任务。</p>

<p>6 rake about</p>

<p>查看rails应用的环境，包括ruby版本，rails版本等。</p>

<p>7 rake notes</p>

<p>查看项目中的 TODO（待完成）、FIXME（待修复）、OPTIMIZE（待优化）</p>

<p>8 rails g</p>

<p>用于生成脚手架、控制器、模型、数据库迁移任务等。  如果加一个 <code>-p</code> 参数，只输出生成的文件列表，而不是真的创建文件</p>

<p>参考资料：</p>

<p>http://guides.ruby-china.org/command_line.html[http://guides.ruby-china.org/command_line.html]</p>
]]></content>
  </entry>
  
</feed>
